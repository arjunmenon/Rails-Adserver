- if defined? param
  - id = RailsAdserver::Advertisement.random_ad(adspace,param)
- else
  - id = nil

- if id != nil
  - advertisement = RailsAdserver::Advertisement.find(id)
  - if advertisement.ad_type == 'ad_service'
    = advertisement.ad_text.html_safe
  - elsif advertisement.ad_type == 'image_link'
    %a{:href => rails_adserver.ad_click_path(id), :rel => "nofollow"}
      = image_tag advertisement.image_url, :size => "#{advertisement.width}x#{advertisement.height}"
- else 
  - geo_ip = Geokit::Geocoders::MultiGeocoder.geocode(request.remote_ip)
  - geo =  Geokit::Geocoders::MultiGeocoder.geocode("#{geo_ip.city},#{geo_ip.state},#{geo_ip.country}")
  - id =  RailsAdserver::Advertisement.geo_city(adspace, geo.city)
  - if id
    - advertisement = RailsAdserver::Advertisement.find(id)
    -if advertisement.ad_type == 'ad_service'
      = advertisement.ad_text.html_safe
    - elsif advertisement.ad_type == 'image_link'
      %a{:href => rails_adserver.ad_click_path(id), :rel => "nofollow"}
        = image_tag advertisement.image_url, :size => "#{advertisement.width}x#{advertisement.height}"
  - else
    - id = RailsAdserver::Advertisement.geo_state(adspace, geo.state)
    -if id
      - advertisement = RailsAdserver::Advertisement.find(id)
      -if advertisement.ad_type == 'ad_service'
        = advertisement.ad_text.html_safe
      - elsif advertisement.ad_type == 'image_link'
        %a{:href => rails_adserver.ad_click_path(id), :rel => "nofollow"}
          = image_tag advertisement.image_url, :size => "#{advertisement.width}x#{advertisement.height}"
    - else
      - id = RailsAdserver::Advertisement.geo_country(adspace, geo.country)
      - if id
        - advertisement = RailsAdserver::Advertisement.find(id)
        -if advertisement.ad_type == 'ad_service'
          = advertisement.ad_text.html_safe
        - elsif advertisement.ad_type == 'image_link'
          %a{:href => rails_adserver.ad_click_path(id), :rel => "nofollow"}
            = image_tag advertisement.image_url, :size => "#{advertisement.width}x#{advertisement.height}"
      - else
        - id = RailsAdserver::Advertisement.random_ad(adspace,nil)
        - unless id == nil
          - advertisement = RailsAdserver::Advertisement.find(id)
          -if advertisement.ad_type == 'ad_service'
            = advertisement.ad_text.html_safe
          - elsif advertisement.ad_type == 'image_link'
            %a{:href => rails_adserver.ad_click_path(id), :rel => "nofollow"}
              = image_tag advertisement.image_url, :size => "#{advertisement.width}x#{advertisement.height}"